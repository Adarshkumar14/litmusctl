name: Release
on:
  create:
    tags:
      - v*

jobs:
  release:
    name: Release on GitHub
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v1

      - name: Validates GO releaser config
        uses: docker://goreleaser/goreleaser:latest
        with:
          args: check

      - name: Create release on GitHub
        uses: docker://goreleaser/goreleaser:latest
        with:
          args: release
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Remove older binaries from latest directory of S3 bucket
        uses: ItsKarma/aws-cli@v1.70.0
        with:
          args: s3 rm s3://asset.mayadata.io/kuberactl/latest --recursive
        env:
          # Make sure to add the secrets in the repo settings page
          # AWS_REGION is set to us-east-1 by default
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1

      - name: Get release tag
        shell: bash
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF##*/})"
        id: release_tag

      - name: Upload Darwin_x86_64 tar to latest directory of S3 bucket
        uses: ItsKarma/aws-cli@v1.70.0
        with:
          args: s3 cp dist/kuberactl_${{ steps.release_tag.outputs.branch }}_Darwin_x86_64.tar.gz s3://asset.mayadata.io/kuberactl/latest/kuberactl_latest_Darwin_x86_64.tar.gz --acl public-read
        env:
          # Make sure to add the secrets in the repo settings page
          # AWS_REGION is set to us-east-1 by default
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1

      - name: Upload Linux_i386 tar to latest directory of S3 bucket
        uses: ItsKarma/aws-cli@v1.70.0
        with:
          args: s3 cp dist/kuberactl_${{ steps.release_tag.outputs.branch }}_Linux_i386.tar.gz s3://asset.mayadata.io/kuberactl/latest/kuberactl_latest_Linux_i386.tar.gz --acl public-read
        env:
          # Make sure to add the secrets in the repo settings page
          # AWS_REGION is set to us-east-1 by default
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1

      - name: Upload Linux_x86_64 tar to latest directory of S3 bucket
        uses: ItsKarma/aws-cli@v1.70.0
        with:
          args: s3 cp dist/kuberactl_${{ steps.release_tag.outputs.branch }}_Linux_x86_64.tar.gz s3://asset.mayadata.io/kuberactl/latest/kuberactl_latest_Linux_x86_64.tar.gz --acl public-read
        env:
          # Make sure to add the secrets in the repo settings page
          # AWS_REGION is set to us-east-1 by default
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1

      - name: Upload binaries to the build version directory
        uses: ItsKarma/aws-cli@v1.70.0
        with:
          args: s3 sync dist s3://asset.mayadata.io/kuberactl/${{ steps.release_tag.outputs.branch }} --exclude "*" --include "*.gz" --acl public-read
        env:
          # Make sure to add the secrets in the repo settings page
          # AWS_REGION is set to us-east-1 by default
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1